<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WikiCite</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b0b0b; color:#f3f3f3; }
    .wrap { max-width: 820px; margin: 0 auto; padding: 18px; }
    .card { background:#151515; border:1px solid #262626; border-radius: 14px; padding: 16px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    p { margin: 8px 0 14px; color:#cfcfcf; }
    label { display:block; font-size: 13px; color:#cfcfcf; margin: 10px 0 6px; }
    input, textarea, button {
      width: 100%; box-sizing: border-box; border-radius: 10px;
      border:1px solid #2b2b2b; background:#0f0f0f; color:#f3f3f3;
      padding: 12px; font-size: 16px;
    }
    textarea { min-height: 170px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .row { display:flex; gap:10px; flex-wrap: wrap; margin-top: 10px; }
    .row > * { flex: 1 1 180px; }
    button { cursor:pointer; background:#1f1f1f; }
    button:hover { background:#252525; }
    .small { font-size: 12px; color:#bdbdbd; margin-top: 10px; }
    .err { color: #ff9a9a; white-space: pre-wrap; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>WikiCite_nl</h1>
      <p>Citeersjablonen vanaf DOI/PMID/url
        versimpelde format (auteurslijst gecondenseerd, refname).</p>

      <label for="doi">DOI</label>
      <input id="doi" placeholder="e.g., 10.1038/s41586-020-2649-2" autocomplete="off" />

      <div class="row">
        <button id="go">Genereer citatie</button>
        <button id="copy" disabled>Kopieer code</button>
        <button id="clear">Clear</button>
      </div>

      <div id="status" class="small"></div>
      <div id="error" class="err"></div>

      <textarea id="out" readonly placeholder="generated citation will appear here..."></textarea>

      <div class="small">
        @TheBartgry. Metadata van Crossref.
      </div>
    </div>
  </div>

<script>
  function extractIds(raw) {
  if (!raw) return { doi: "", pmid: "" };
  const s = String(raw).trim();

  // DOI: find first DOI-like token anywhere
  const doiMatch = s.match(/10\.\d{4,9}\/[^\s"'<>[\])]+/i);
  const doi = doiMatch ? doiMatch[0].replace(/[.,;:!?]+$/g, "") : "";

  // PMID: either "PMID: 12345" or a PubMed URL containing /12345/
  let pmid = "";
  const pmidMatch = s.match(/\bPMID\s*:\s*(\d{4,10})\b/i);
  if (pmidMatch) pmid = pmidMatch[1];

  if (!pmid) {
    const pubmedUrlMatch = s.match(/pubmed\.ncbi\.nlm\.nih\.gov\/(\d{4,10})/i);
    if (pubmedUrlMatch) pmid = pubmedUrlMatch[1];
  }

  // or just a bare number (only if it looks like a PMID and no DOI was found)
  if (!pmid && !doi) {
    const bareNum = s.match(/\b(\d{6,10})\b/);
    if (bareNum) pmid = bareNum[1];
  }

  return { doi, pmid };
}

  function pickFirst(v) {
    if (!v) return "";
    return Array.isArray(v) ? (v[0] || "") : v;
  }

  function yearFrom(msg) {
    const dateParts =
      (msg["published-print"] && msg["published-print"]["date-parts"]) ||
      (msg["published-online"] && msg["published-online"]["date-parts"]) ||
      (msg.created && msg.created["date-parts"]) ||
      null;

    if (dateParts && Array.isArray(dateParts) && Array.isArray(dateParts[0])) {
      return String(dateParts[0][0] ?? "");
    }
    return "";
  }

  function joinAuthors(authors) {
  if (!Array.isArray(authors) || authors.length === 0) return "";

  const max = 7;
  const selected = authors.slice(0, max);

  const formatted = selected.map(a => {
    const family = (a.family || "").trim();
    const given = (a.given || "").trim();
    const initials = given
      ? given.split(/\s+/).map(x => x[0]).join("")
      : "";
    return `${family} ${initials}`.trim();
  });

  // add a period only after the last author
  return formatted.join(", ") + ".";
}

  function refNameFromAuthors(authors) {
  if (!Array.isArray(authors) || authors.length === 0) return "ref";

  const family = (authors[0].family || "").trim();
  if (!family) return "ref";

  // take part before dash, lowercase, strip accents
  const base = family.split("-")[0]
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");

  return base.slice(0, 5);
}

  function toWikicodeCiteJournal(msg, doi) {
  const refName = refNameFromAuthors(msg.author);
  const titel = pickFirst(msg.title) || "";
  const journal = pickFirst(msg["container-title"]) || "";
  const volume = msg.volume || "";
  const issue = msg.issue || "";
  const pages = msg.page || "";
  const jaar = yearFrom(msg);
  const auteur = joinAuthors(msg.author);
  const pmid = msg.PMID || "";
  const taal = msg.language || "en";

  const params = [
    ["auteur", auteur],
    ["jaar", jaar],
    ["titel", titel],
    ["journal", journal],
    ["volume", volume],
    ["issue", issue],
    ["pages", pages],
    ["doi", doi],
    ["pmid", pmid],
    ["taal", taal]
  ].filter(([_, v]) => String(v || "").trim() !== "");

  const body = params
    .map(([k, v]) => ` | ${k} = ${v}`)
    .join("");

  return `<ref name="${refName}">{{Citeer journal${body} }}</ref>`;
}

  async function fetchCrossref(doi) {
    const endpoint = `https://api.crossref.org/works/${encodeURIComponent(doi)}`;
    const res = await fetch(endpoint, { headers: { "Accept": "application/json" } });
    if (!res.ok) {
      const text = await res.text().catch(() => "");
      throw new Error(`Crossref error (${res.status}). ${text.slice(0, 200)}`);
    }
    const data = await res.json();
    if (!data?.message) throw new Error("Unexpected Crossref response.");
    return data.message;
  }
  async function fetchPubmedSummary(pmid) {
  const endpoint = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id=${encodeURIComponent(pmid)}&retmode=json`;
  const res = await fetch(endpoint, { headers: { "Accept": "application/json" } });
  if (!res.ok) throw new Error(`PubMed error (${res.status}).`);
  const data = await res.json();
  const rec = data?.result?.[pmid];
  if (!rec) throw new Error("Unexpected PubMed response.");
  return rec;
}


  const $doi = document.getElementById("doi");
  const $out = document.getElementById("out");
  const $status = document.getElementById("status");
  const $error = document.getElementById("error");
  const $copy = document.getElementById("copy");

  function setStatus(s) { $status.textContent = s || ""; }
  function setError(s) { $error.textContent = s || ""; }

  async function generate() {
    setError("");
    const ids = extractIds($doi.value);
    const doi = ids.doi;
    const pmidInput = ids.pmid;

    if (!doi && !pmidInput) {
    setError("Please paste a DOI or a PMID (or a PubMed/DOI URL)."); return;}

    setStatus("Fetching metadata…");
    $out.value = "";
    $copy.disabled = true;

    try {
  if (doi) {
    const msg = await fetchCrossref(doi);
    setStatus("Generating wikicode…");
    $out.value = toWikicodeCiteJournal(msg, doi);
  } else {
    const rec = await fetchPubmedSummary(pmidInput);
    setStatus("Generating wikicode…");

    // Build a Crossref-like object with the fields your template function expects
    const msg = {
      title: [rec.title || ""],
      "container-title": [rec.fulljournalname || ""],
      volume: rec.volume || "",
      issue: rec.issue || "",
      page: rec.pages || "",
      language: "en",
      author: (rec.authors || []).map(a => {
        // PubMed gives "Lastname AB" already; we split into family+given roughly
        const parts = (a.name || "").trim().split(" ");
        return { family: parts[0] || "", given: parts.slice(1).join(" ") || "" };
      }),
      PMID: String(rec.uid || pmidInput)
    };

    // Try to grab DOI from PubMed articleids
    const doiId = (rec.articleids || []).find(x => x.idtype === "doi")?.value || "";
    $out.value = toWikicodeCiteJournal(msg, doiId);
  }

  $copy.disabled = false;
  setStatus("Done.");
} catch (e) {
  setStatus("");
  setError(String(e?.message || e));
}
 catch (e) {
      setStatus("");
      setError(String(e?.message || e));
    }
  }

  document.getElementById("go").addEventListener("click", generate);
  $doi.addEventListener("keydown", (e) => { if (e.key === "Enter") generate(); });

  document.getElementById("copy").addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText($out.value);
      setStatus("Copied ✅");
      setTimeout(() => setStatus("Done."), 900);
    } catch {
      setError("Copy failed. Select text and copy manually.");
    }
  });

  document.getElementById("clear").addEventListener("click", () => {
    $doi.value = "";
    $out.value = "";
    setStatus("");
    setError("");
    $copy.disabled = true;
    $doi.focus();
  });
</script>
</body>
</html>
