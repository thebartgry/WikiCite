<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WikiCite</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b0b0b; color:#f3f3f3; }
    .wrap { max-width: 820px; margin: 0 auto; padding: 18px; }
    .card { background:#151515; border:1px solid #262626; border-radius: 14px; padding: 16px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    p { margin: 8px 0 14px; color:#cfcfcf; }
    label { display:block; font-size: 13px; color:#cfcfcf; margin: 10px 0 6px; }
    input, textarea, button {
      width: 100%; box-sizing: border-box; border-radius: 10px;
      border:1px solid #2b2b2b; background:#0f0f0f; color:#f3f3f3;
      padding: 12px; font-size: 16px;
    }
    textarea { min-height: 170px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .row { display:flex; gap:10px; flex-wrap: wrap; margin-top: 10px; }
    .row > * { flex: 1 1 180px; }
    button { cursor:pointer; background:#1f1f1f; }
    button:hover { background:#252525; }
    .small { font-size: 12px; color:#bdbdbd; margin-top: 10px; }
    .err { color: #ff9a9a; white-space: pre-wrap; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>WikiCite_nl</h1>
      <p>Citeersjablonen vanaf DOI, versimpelde output (auteurslijst gecondenseerd, refname klein).</p>

      <label for="doi">DOI</label>
      <input id="doi" placeholder="e.g., 10.1038/s41586-020-2649-2" autocomplete="off" />

      <div class="row">
        <button id="go">Genereer citatie</button>
        <button id="copy" disabled>Kopieer code</button>
        <button id="clear">Clear</button>
      </div>

      <div id="status" class="small"></div>
      <div id="error" class="err"></div>

      <textarea id="out" readonly placeholder="generated citation will appear here..."></textarea>

      <div class="small">
        Gebruikt metadata van Crossref.
      </div>
    </div>
  </div>

<script>
  function normalizeDOI(raw) {
  if (!raw) return "";
  const s = String(raw).trim();

  // 1) If it's a DOI URL, strip the domain
  const urlStripped = s.replace(/^https?:\/\/(dx\.)?doi\.org\//i, "").replace(/^doi:\s*/i, "");

  // 2) Extract the first DOI-like pattern anywhere in the text
  // DOI format: starts with 10.<digits>/
  const m = urlStripped.match(/10\.\d{4,9}\/[^\s"'<>\]\)]+/i);
  if (!m) return "";

  // 3) Clean common trailing punctuation
  return m[0].replace(/[.,;:!?]+$/g, "");
}

  function pickFirst(v) {
    if (!v) return "";
    return Array.isArray(v) ? (v[0] || "") : v;
  }

  function yearFrom(msg) {
    const dateParts =
      (msg["published-print"] && msg["published-print"]["date-parts"]) ||
      (msg["published-online"] && msg["published-online"]["date-parts"]) ||
      (msg.created && msg.created["date-parts"]) ||
      null;

    if (dateParts && Array.isArray(dateParts) && Array.isArray(dateParts[0])) {
      return String(dateParts[0][0] ?? "");
    }
    return "";
  }

  function joinAuthors(authors) {
  if (!Array.isArray(authors) || authors.length === 0) return "";

  const max = 7;
  const selected = authors.slice(0, max);

  const formatted = selected.map(a => {
    const family = (a.family || "").trim();
    const given = (a.given || "").trim();
    const initials = given
      ? given.split(/\s+/).map(x => x[0]).join("")
      : "";
    return `${family} ${initials}`.trim();
  });

  // add a period only after the last author
  return formatted.join(", ") + ".";
}

  function refNameFromAuthors(authors) {
  if (!Array.isArray(authors) || authors.length === 0) return "ref";

  const family = (authors[0].family || "").trim();
  if (!family) return "ref";

  // take part before dash, lowercase, strip accents
  const base = family.split("-")[0]
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");

  return base.slice(0, 5);
}

  function toWikicodeCiteJournal(msg, doi) {
  const refName = refNameFromAuthors(msg.author);
  const titel = pickFirst(msg.title) || "";
  const journal = pickFirst(msg["container-title"]) || "";
  const volume = msg.volume || "";
  const issue = msg.issue || "";
  const pages = msg.page || "";
  const jaar = yearFrom(msg);
  const auteur = joinAuthors(msg.author);
  const pmid = msg.PMID || "";
  const taal = msg.language || "en";

  const params = [
    ["auteur", auteur],
    ["jaar", jaar],
    ["titel", titel],
    ["journal", journal],
    ["volume", volume],
    ["issue", issue],
    ["pages", pages],
    ["doi", doi],
    ["pmid", pmid],
    ["taal", taal]
  ].filter(([_, v]) => String(v || "").trim() !== "");

  const body = params
    .map(([k, v]) => ` | ${k} = ${v}`)
    .join("");

  return `<ref name="${refName}">{{Citeer journal${body} }}</ref>`;
}

  async function fetchCrossref(doi) {
    const endpoint = `https://api.crossref.org/works/${encodeURIComponent(doi)}`;
    const res = await fetch(endpoint, { headers: { "Accept": "application/json" } });
    if (!res.ok) {
      const text = await res.text().catch(() => "");
      throw new Error(`Crossref error (${res.status}). ${text.slice(0, 200)}`);
    }
    const data = await res.json();
    if (!data?.message) throw new Error("Unexpected Crossref response.");
    return data.message;
  }

  const $doi = document.getElementById("doi");
  const $out = document.getElementById("out");
  const $status = document.getElementById("status");
  const $error = document.getElementById("error");
  const $copy = document.getElementById("copy");

  function setStatus(s) { $status.textContent = s || ""; }
  function setError(s) { $error.textContent = s || ""; }

  async function generate() {
    setError("");
    const doi = normalizeDOI($doi.value);
    if (!doi) { setError("Please enter a DOI (e.g., 10.1038/...)."); return; }

    setStatus("Fetching metadata…");
    $out.value = "";
    $copy.disabled = true;

    try {
      const msg = await fetchCrossref(doi);
      setStatus("Generating wikicode…");
      $out.value = toWikicodeCiteJournal(msg, doi);
      $copy.disabled = false;
      setStatus("Done.");
    } catch (e) {
      setStatus("");
      setError(String(e?.message || e));
    }
  }

  document.getElementById("go").addEventListener("click", generate);
  $doi.addEventListener("keydown", (e) => { if (e.key === "Enter") generate(); });

  document.getElementById("copy").addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText($out.value);
      setStatus("Copied ✅");
      setTimeout(() => setStatus("Done."), 900);
    } catch {
      setError("Copy failed. Select text and copy manually.");
    }
  });

  document.getElementById("clear").addEventListener("click", () => {
    $doi.value = "";
    $out.value = "";
    setStatus("");
    setError("");
    $copy.disabled = true;
    $doi.focus();
  });
</script>
</body>
</html>
