<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WikiCite – ISBN → Citeer boek</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b0b0b; color:#f3f3f3; }
    .wrap { max-width: 820px; margin: 0 auto; padding: 18px; }
    .card { background:#151515; border:1px solid #262626; border-radius: 14px; padding: 16px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    p { margin: 8px 0 14px; color:#cfcfcf; }
    label { display:block; font-size: 13px; color:#cfcfcf; margin: 10px 0 6px; }
    input, textarea, button {
      width: 100%; box-sizing: border-box; border-radius: 10px;
      border:1px solid #2b2b2b; background:#0f0f0f; color:#f3f3f3;
      padding: 12px; font-size: 16px;
    }
    textarea { min-height: 160px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .row { display:flex; gap:10px; flex-wrap: wrap; margin-top: 10px; }
    .row > * { flex: 1 1 180px; }
    button { cursor:pointer; background:#1f1f1f; }
    button:hover { background:#252525; }
    .small { font-size: 12px; color:#bdbdbd; margin-top: 10px; }
    .err { color: #ff9a9a; white-space: pre-wrap; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ISBN → Citeer boek</h1>
      <p>Plak een ISBN (met of zonder extra tekst).</p>

      <label for="isbn">ISBN</label>
      <input id="isbn" placeholder="bijv. ISBN: 978-0-393-42708-0." autocomplete="off" />

      <div class="row">
        <button id="go">Genereer referentie</button>
        <button id="copy" disabled>Kopieer</button>
        <button id="clear">Wissen</button>
      </div>

      <div id="status" class="small"></div>
      <div id="error" class="err"></div>

      <label for="out">Wikicode</label>
      <textarea id="out" readonly></textarea>
    </div>
  </div>

<script>
/* ---------- helpers ---------- */

function normalizeISBN(raw) {
  if (!raw) return "";
  const m = String(raw).replace(/[^0-9Xx]/g, "").match(/(97[89]\d{10}|\d{9}[0-9Xx])/);
  return m ? m[1].toUpperCase() : "";
}

function toNormalCase(s) {
  return s
    .toLowerCase()
    .replace(/\b\p{L}/gu, c => c.toUpperCase());
}

function formatAuthors(authors) {
  if (!Array.isArray(authors) || authors.length === 0) return "";

  const max = 5;
  const selected = authors.slice(0, max);

  const names = selected.map(a => {
    const name = toNormalCase(a.name || "");
    const parts = name.split(" ");
    const last = parts.pop();
    const initials = parts.map(p => p[0]).join("");
    return `${last} ${initials}`.trim();
  });

  return names.join(", ") + ".";
}

async function fetchOpenLibrary(isbn) {
  const url = `https://openlibrary.org/isbn/${isbn}.json`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("ISBN niet gevonden in Open Library.");
  return res.json();
}

async function fetchAuthors(authorRefs) {
  if (!Array.isArray(authorRefs)) return [];
  const out = [];
  for (const a of authorRefs.slice(0, 5)) {
    try {
      const res = await fetch(`https://openlibrary.org${a.key}.json`);
      if (res.ok) out.push(await res.json());
    } catch {}
  }
  return out;
}

function refNameFromAuthors(authors) {
  if (!authors || authors.length === 0) return "boek";
  const base = authors[0].name
    .split(" ")[0]
    .split("-")[0]
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
  return base.slice(0, 5);
}

async function copyOutput() {
  try {
    await navigator.clipboard.writeText($out.value);
    setStatus("Gekopieerd ✅");
    setTimeout(() => setStatus("Klaar."), 900);
  } catch {
    setError("Automatisch kopiëren mislukt. Selecteer en kopieer handmatig.");
  }
}

/* ---------- main ---------- */

const $isbn = document.getElementById("isbn");
const $out = document.getElementById("out");
const $status = document.getElementById("status");
const $error = document.getElementById("error");
const $copy = document.getElementById("copy");

function setStatus(s) { $status.textContent = s || ""; }
function setError(s) { $error.textContent = s || ""; }

async function generate() {
  setError("");
  const isbn = normalizeISBN($isbn.value);
  if (!isbn) { setError("Geen geldig ISBN gevonden."); return; }

  setStatus("Metadata ophalen…");
  $out.value = "";
  $copy.disabled = true;

  try {
    const book = await fetchOpenLibrary(isbn);
    const authorsRaw = await fetchAuthors(book.authors);
    const auteur = formatAuthors(authorsRaw);
    const refName = refNameFromAuthors(authorsRaw);

    const wikicode =
`<ref name="${refName}">{{Citeer boek | auteur = ${auteur} | datum = ${book.publish_date || ""} | titel = ${book.title || ""} | editie = ${book.edition_name || ""} | uitgever = ${(book.publishers || [])[0] || ""} | isbn = ${isbn} | pages = | chapter = | taal = en }}</ref>`;

    $out.value = wikicode;
    $copy.disabled = false;
    await copyOutput();
  } catch (e) {
    setError(e.message);
    setStatus("");
  }
}

document.getElementById("go").addEventListener("click", generate);
document.getElementById("copy").addEventListener("click", copyOutput);
document.getElementById("clear").addEventListener("click", () => {
  $isbn.value = "";
  $out.value = "";
  setStatus("");
  setError("");
  $copy.disabled = true;
});
</script>
</body>
</html>
